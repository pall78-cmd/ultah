<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dossier: Aristia Firlin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,900;1,900&family=Special+Elite&family=EB+Garamond:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        
        :root {
            --paper: #f2ecd9;
            --ink: #1a1a1a;
            --accent: #8b0000;
        }

        body {
            background-color: #050505;
            font-family: 'Courier Prime', monospace;
            color: var(--ink);
            overflow: hidden;
            overscroll-behavior: none;
        }

        /* --- CONSTELLATION LOADING --- */
        #constellation-loader {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 600;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .star { fill: #fff; filter: drop-shadow(0 0 3px #fff); }
        .const-line { stroke: rgba(255,255,255,0.3); stroke-width: 1; stroke-dasharray: 100; stroke-dashoffset: 100; animation: drawLine 2s ease forwards; }
        
        @keyframes drawLine { to { stroke-dashoffset: 0; } }
        @keyframes starTwinkle { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        .twinkle { animation: starTwinkle 1.5s infinite ease-in-out; }

        /* --- SCANLINE LOGIN --- */
        #scanning-line {
            position: absolute; width: 100%; height: 3px;
            background: linear-gradient(to bottom, transparent, var(--accent), transparent);
            top: -10px; z-index: 100;
            box-shadow: 0 0 20px var(--accent);
            display: none;
            pointer-events: none;
        }
        
        .scanning-active #scanning-line {
            display: block;
            animation: scanLoop 2.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes scanLoop {
            0% { top: 0%; opacity: 0; }
            15% { opacity: 1; }
            85% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* --- AUTH SCREEN --- */
        #auth-module {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            position: fixed;
            inset: 0;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .terminal-container { width: 90%; max-width: 400px; text-align: center; }

        .init-btn {
            border: 1px solid #444; color: #888; padding: 15px 30px;
            text-transform: uppercase; letter-spacing: 5px; font-size: 10px;
            cursor: pointer; transition: all 0.5s; background: transparent;
        }

        .decode-interface { display: none; }

        /* --- MAIN CONTAINER --- */
        .paper-container {
            background-color: var(--paper);
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
            box-shadow: inset 0 0 80px rgba(0,0,0,0.1), 0 20px 50px rgba(0,0,0,0.8);
            height: 94vh; width: 100%; max-width: 420px;
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            margin: auto;
        }

        .page-module {
            display: none; opacity: 0; height: 100%;
            flex-direction: column; padding: 1.5rem;
            overflow-y: auto;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Victorian Wallpaper for specific pages */
        .victorian-bg::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: url("https://www.transparenttextures.com/patterns/damask.png");
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }

        .page-module.active { display: flex; opacity: 1; }

        /* NAV ZONE: z-index 40. Ini yang menutupi tombol jika tombol z-index nya < 40 */
        .nav-zone { position: absolute; top: 0; bottom: 0; width: 20%; z-index: 40; cursor: pointer; }
        .nav-left { left: 0; }
        .nav-right { right: 0; }

        .page-module > * { position: relative; z-index: 1; }

        /* --- EVIDENCE FORM --- */
        .evidence-form {
            border: 1px solid #333;
            padding: 1.25rem;
            position: relative;
            background: rgba(255,255,255,0.3);
            height: 75%;
            display: flex;
            flex-direction: column;
        }

        .status-strip-visual {
            margin-top: 1rem;
            height: calc(25% - 2rem);
            border: 1px dashed rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.03);
        }

        .binary-rain {
            position: absolute;
            font-size: 8px;
            color: rgba(0,0,0,0.05);
            line-height: 1;
            word-break: break-all;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 5px;
            user-select: none;
        }

        .passed-stamp {
            border: 3px double #1a4a1a;
            color: #1a4a1a;
            padding: 4px 12px;
            font-weight: 900;
            font-size: 14px;
            transform: rotate(-5deg);
            z-index: 5;
            background: rgba(242, 236, 217, 0.8);
            letter-spacing: 2px;
        }

        .photo-clip-container { position: absolute; top: -12px; right: 12px; z-index: 20; }
        .clip-on { width: 22px; height: 40px; background: url('https://img.icons8.com/ios-filled/50/000000/paper-clip.png') no-repeat; background-size: contain; position: absolute; top: -4px; left: 50%; transform: translateX(-50%); z-index: 30; }
        .photo-3x4 { width: 85px; height: 113px; background: #fff; padding: 3px; border: 1px solid #999; box-shadow: 3px 3px 8px rgba(0,0,0,0.2); transform: rotate(2deg); }
        .photo-3x4 img { width: 100%; height: 100%; object-fit: cover; }
        
        .form-row { margin-bottom: 0.5rem; border-bottom: 1px dotted rgba(0,0,0,0.2); display: flex; align-items: baseline; font-size: 10.5px; line-height: 1.4; }
        .label { font-weight: bold; width: 85px; text-transform: uppercase; color: #666; font-size: 9px; }
        .value { flex: 1; color: var(--ink); font-weight: bold; }
        
        .stamp-container-v2 {
            margin-top: auto;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
        }

        .round-stamp {
            width: 75px;
            height: 75px;
            border: 2px dashed #8b0000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #8b0000;
            font-weight: 900;
            font-size: 7px;
            text-transform: uppercase;
            transform: rotate(-15deg);
            opacity: 0.6;
            position: relative;
        }

        .round-stamp::after {
            content: "TOP SECRET";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            border-top: 1px solid #8b0000;
            border-bottom: 1px solid #8b0000;
            padding: 2px 0;
            width: 120%;
            background: var(--paper);
        }

        .fingerprint-zone {
            width: 50px;
            height: 60px;
            opacity: 0.25;
            filter: grayscale(1) contrast(1.5);
            margin-right: 10px;
        }

        .barcode-strip {
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 20px;
            opacity: 0.15;
            background: repeating-linear-gradient(90deg, #000, #000 1px, transparent 1px, transparent 4px);
        }

        /* --- NYT STYLE HEADLINE --- */
        .nyt-lead {
            font-family: 'EB Garamond', serif;
            font-size: 1.45rem;
            line-height: 1.2;
            font-weight: 700;
            margin-bottom: 1.25rem;
            text-align: left;
            color: #000;
        }

        .nyt-lead::first-letter {
            float: left;
            font-size: 4.5rem;
            line-height: 0.8;
            margin-top: 0.1em;
            margin-right: 0.1em;
            font-family: 'Playfair Display', serif;
            font-weight: 900;
        }

        .quote-block {
            margin: 1.5rem 0;
            padding: 1rem;
            border-left: 2px solid var(--accent);
            background: rgba(139, 0, 0, 0.03);
            font-style: italic;
            font-family: 'EB Garamond', serif;
            font-size: 1.1rem;
            color: #555;
        }

        .reel-btn { display: block; padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.15); text-align: center; color: var(--accent); font-size: 10px; font-weight: bold; letter-spacing: 0.15em; animation: soft-pulse 3.5s infinite ease-in-out; }
        @keyframes soft-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .date-highlight { background: var(--accent); color: white; border-radius: 9999px; font-weight: bold; transform: scale(1.1); position: relative; }
        .active .date-highlight { animation: pulse-date 2.2s infinite ease-in-out; }
        @keyframes pulse-date { 0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.6); } 70% { box-shadow: 0 0 0 8px rgba(139, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); } }
        
        /* PERBAIKAN TYPEWRITER 
           1. Text align left (bukan justify) agar huruf tidak lompat-lompat.
           2. Min-height agar elemen di bawahnya tidak bergeser saat teks bertambah.
        */
        #typewriter-output { 
            white-space: pre-wrap; 
            font-family: 'Special Elite', cursive; 
            line-height: 1.8; 
            color: #444; 
            font-size: 13px; 
            text-align: left; /* PERBAIKAN: Justify diganti Left */
            min-height: 220px; /* PERBAIKAN: Menjaga layout tetap stabil */
        }
        
        /* --- CHAT SYSTEM --- */
        #msg-display { background: rgba(0,0,0,0.03); padding: 1rem; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message-bubble { padding: 8px 12px; max-width: 80%; font-size: 11px; }
        .msg-n { align-self: flex-start; background: #fff; border-left: 4px solid var(--accent); border-radius: 0 8px 8px 8px; }
        .msg-aristia { align-self: flex-end; background: #222; color: #fff; border-radius: 8px 0 8px 8px; }
        
        .identity-toggle { display: flex; background: rgba(0,0,0,0.08); padding: 3px; margin-bottom: 10px; width: fit-content; border-radius: 4px; }
        .toggle-btn { padding: 4px 15px; font-size: 10px; cursor: pointer; border-radius: 2px; }
        .toggle-btn.active { background: var(--accent); color: white; }
        
        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }

        /* --- NAV ELEMENTS --- */
        #back-nav-btn {
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid rgba(139, 0, 0, 0.3);
            background: rgba(139, 0, 0, 0.05);
            color: var(--accent);
            display: none;
            margin-right: 10px;
        }
        #center-stamp { display: inline-block; }

        /* --- CALENDAR DATA VISUAL --- */
        .radar-box {
            margin-top: 1.5rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .data-readout {
            font-size: 7.5px;
            color: #666;
            display: grid;
            grid-template-cols: 1fr 1fr;
            gap: 5px;
            font-family: 'Courier Prime', monospace;
        }
        .monitor-line {
            height: 30px;
            background: linear-gradient(90deg, transparent 0%, rgba(139, 0, 0, 0.1) 50%, transparent 100%);
            position: relative;
            border-left: 2px solid var(--accent);
            overflow: hidden;
        }
        .monitor-line::after {
            content: "";
            position: absolute;
            left: 0; top: 50%;
            width: 100%;
            height: 1px;
            background: rgba(139, 0, 0, 0.2);
        }
        .wave-pulse {
            position: absolute;
            width: 10px;
            height: 100%;
            background: var(--accent);
            opacity: 0.3;
            animation: movePulse 3s linear infinite;
        }
        @keyframes movePulse {
            0% { left: -10%; }
            100% { left: 110%; }
        }

        /* --- PAGE 3: SURPRISE CANDLE & TYPEWRITER --- */
        #candle-stage {
            position: absolute;
            inset: 0;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 1s;
        }
        .candle {
            width: 20px;
            height: 60px;
            background: #fff;
            position: relative;
            border-radius: 2px;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .flame {
            width: 12px;
            height: 25px;
            background: #ff9800;
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 50% 50% 20% 20%;
            animation: flicker 0.1s infinite alternate;
            box-shadow: 0 0 15px #ff9800, 0 0 30px #ff5722;
            cursor: pointer;
        }
        @keyframes flicker {
            0% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1.1) skew(2deg); }
        }
        .candle-glow {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,152,0,0.15) 0%, transparent 70%);
            top: -90px;
            pointer-events: none;
        }
        .candle-hint {
            color: #444;
            font-size: 8px;
            margin-top: 40px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .wax-seal-decoration {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 1.5s;
        }
        .red-ribbon {
            width: 2px;
            height: 30px;
            background: #8b0000;
            position: relative;
        }
        .wax-seal {
            width: 35px;
            height: 35px;
            background: #8b0000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            border: 2px solid #630101;
            position: relative;
            margin-top: -5px;
        }
        .wax-seal::after {
            content: "17";
            color: #630101;
            font-weight: bold;
            font-size: 14px;
            font-family: 'Playfair Display';
        }

        .verification-grid {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px; 
            opacity: 0.6;
            padding: 0 10px;
        }
        .bio-info { display: flex; flex-direction: column; gap: 3px; text-align: right; }
        .bio-row { font-size: 6.5px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; display: flex; justify-content: flex-end; gap: 6px; }
        .bio-val { font-weight: bold; color: var(--accent); }
        
        .retro-qr-graphic {
            width: 40px;
            height: 40px;
            background-image: linear-gradient(90deg, #000 25%, transparent 25%, transparent 75%, #000 75%), linear-gradient(#000 25%, transparent 25%, transparent 75%, #000 75%);
            background-size: 10px 10px; border: 1px solid #ddd; position: relative;
        }
        .retro-qr-graphic::after { content: ""; position: absolute; inset: 10px; background: #8b0000; opacity: 0.2; }

        .footer-shred {
            width: 100%; height: 40px; margin-top: 15px;
            background: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 11px);
            border-top: 1px solid rgba(0,0,0,0.05); mask-image: linear-gradient(to bottom, black, transparent);
        }

        /* --- FLASH EFFECT --- */
        #flash-overlay { position: fixed; inset: 0; background: #fff; opacity: 0; z-index: 200; pointer-events: none; }
        .flash-active { animation: flashAnim 0.8s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 1; } 10% { opacity: 0; } 20% { opacity: 0.8; } 100% { opacity: 0; } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="flash-overlay"></div>

    <!-- Animasi Rasi Bintang Sagittarius Loading -->
    <div id="constellation-loader">
        <svg viewBox="0 0 200 200" width="180" height="180" class="mb-4">
            <!-- Sagittarius Pattern -->
            <g class="twinkle">
                <circle cx="100" cy="40" r="2" class="star" /> <!-- Kaus Borealis -->
                <circle cx="120" cy="70" r="2" class="star" /> <!-- Kaus Media -->
                <circle cx="110" cy="110" r="2" class="star" /> <!-- Kaus Australis -->
                <circle cx="70" cy="90" r="2" class="star" /> <!-- Alnasl -->
                <circle cx="150" cy="60" r="2" class="star" /> <!-- Nunki -->
                <circle cx="140" cy="95" r="2" class="star" /> <!-- Ascella -->
            </g>
            <path d="M100 40 L120 70 L110 110 L70 90 L120 70 M120 70 L150 60 L140 95 L110 110" fill="none" class="const-line" />
        </svg>
        <p class="text-[9px] uppercase tracking-[0.4em] opacity-60">Aligning Sagittarius...</p>
    </div>

    <!-- Modal Purge -->
    <div id="delete-modal" class="custom-modal">
        <div class="bg-[#f2ecd9] p-6 max-w-xs w-full border-t-8 border-red-900 text-center shadow-2xl relative z-50">
            <h3 class="font-bold uppercase text-[10px] tracking-widest mb-2">Penghancuran Berkas?</h3>
            <p class="text-[9px] mb-6 opacity-70">Log transmisi akan dihapus secara permanen.</p>
            <div class="flex gap-4">
                <button onclick="DossierSystem.closeModal()" class="flex-1 py-2 border border-black text-[9px] uppercase">Abort</button>
                <button onclick="DossierSystem.confirmPurge()" class="flex-1 py-2 bg-red-900 text-white text-[9px] uppercase">Execute</button>
            </div>
        </div>
    </div>

    <!-- Login Auth -->
    <div id="auth-module" class="scanning-active">
        <div id="scanning-line"></div>
        <div id="init-screen" class="terminal-container">
            <button class="init-btn" onclick="DossierSystem.showPin()">Access Archive</button>
        </div>
        <div id="pin-screen" class="terminal-container decode-interface">
            <input type="password" id="pin-field" maxlength="6" class="w-full bg-transparent border-b border-red-900 text-center text-4xl text-red-700 outline-none tracking-[0.5em] py-2" placeholder="******">
            <p class="text-[9px] mt-6 text-white/40 tracking-widest uppercase">Hint: 300326</p>
        </div>
    </div>

    <main class="paper-container">
        <!-- Navigasi Samping: z-index 40 -->
        <div id="nav-l" class="nav-zone nav-left" onclick="DossierSystem.prev()"></div>
        <div id="nav-r" class="nav-zone nav-right" onclick="DossierSystem.next()"></div>

        <div id="module-viewport" class="flex-1 relative overflow-hidden">
            
            <!-- Halaman 0: Editorial NYT Style -->
            <section class="page-module victorian-bg active" id="mod-0">
                <div class="text-center mb-2">
                    <p class="text-[9px] uppercase tracking-[0.4em] opacity-50">Special Issue: March 30, 2026</p>
                </div>
                <h1 class="text-6xl text-center border-y-2 border-black py-3 my-4 font-black italic tracking-tighter" style="font-family: 'Playfair Display', serif;">The Ledger</h1>
                
                <div class="space-y-4 text-justify leading-relaxed" style="font-family: 'EB Garamond', serif;">
                    <p class="nyt-lead">
                        Tepat pada koordinat waktu yang telah ditentukan, <b>sayangku</b> secara resmi memasuki fase kedewasaan ke-17 tahun, menandai berakhirnya sebuah era dan dimulainya babak baru yang lebih krusial.
                    </p>
                    <p class="text-[1.1rem]">Laporan intelijen ini bukan sekadar arsip rutin, melainkan bukti otentik dari perjalanan panjang yang penuh makna. <b>Tujuh belas tahun</b> bukanlah sekadar angka dalam kalender, melainkan akumulasi dari setiap tawa, mimpi, dan keberanian yang telah kamu bentuk dengan indah, <b>sayangku</b>.</p>
                    <div class="quote-block">
                        "Beberapa jiwa bersinar terlalu terang untuk sekadar dilewatkan oleh waktu; mereka adalah naskah yang ditulis oleh takdir."
                    </div>
                    <p class="text-[1.1rem]">Statusmu kini telah ditingkatkan menjadi <b>aset paling berharga</b> dalam sejarah operasional hidupku. Ketahuilah bahwa di setiap detak waktu yang berlalu, <b>sayangku</b> akan selalu menjadi pusat dari segala koordinat kebahagiaanku. Selamat datang di gerbang baru kehidupan.</p>
                </div>
                
                <div class="mt-8 border-l-4 border-red-900 pl-4 italic text-sm opacity-60">"Operasi Sweet Seventeen: Status Aktif."</div>
            </section>

            <!-- Halaman 1: Evidence & Photo Clip -->
            <section class="page-module victorian-bg" id="mod-1">
                <div class="evidence-form">
                    <div class="photo-clip-container">
                        <div class="clip-on"></div>
                        <div class="photo-3x4">
                            <img src="https://muhatawchjjisjalopab.supabase.co/storage/v1/object/public/foto/foto.jpg" alt="Sayangku">
                        </div>
                    </div>
                    <div class="form-header">
                        <div class="text-[12px] font-bold uppercase tracking-[0.2em] text-gray-700">File: 017/AF-MAR</div>
                    </div>
                    <div class="mt-2 space-y-1 pr-[95px]">
                        <div class="form-row"><span class="label">Name:</span><span class="value">ARISTIA FIRLIN</span></div>
                        <div class="form-row"><span class="label">Priority:</span><span class="value">S-CLASS ASSET</span></div>
                        <div class="form-row"><span class="label">Age:</span><span class="value">17 YEARS OLD</span></div>
                        <div class="form-row"><span class="label">Origin:</span><span class="value">30 MARCH 2009</span></div>
                    </div>
                    <div class="mt-4">
                        <div class="bg-black/[0.04] p-3 border border-black/10 rounded-sm">
                            <p class="text-[8px] font-bold uppercase mb-2 opacity-50">Transmission Record:</p>
                            <a href="https://www.instagram.com/reel/DQEbbnuEj95/?igsh=MXJ0ejJ5amxsZW1y" target="_blank" class="reel-btn uppercase">Decrypt Reel Record</a>
                        </div>
                    </div>
                    <div class="mt-4 flex-1">
                        <p class="text-[9.5px] leading-relaxed text-gray-600 italic border-l-2 border-red-900/30 pl-3">
                            "Subjek menunjukkan perkembangan emosional yang signifikan dan tetap menjadi prioritas pengawasan tingkat tinggi."
                        </p>
                    </div>
                    <div class="stamp-container-v2">
                        <div class="round-stamp">
                            AUTHENTICATED<br>BY N. STATION<br>SECURED
                        </div>
                        <img src="https://img.icons8.com/ios/100/000000/fingerprint.png" class="fingerprint-zone" alt="Fingerprint">
                        <div class="barcode-strip"></div>
                    </div>
                </div>
                <div class="status-strip-visual">
                    <div class="binary-rain">01110011 01100001 01111001 01100001 01101110 01100111 01101011 01110101 00100000 00110001 00110111 00100000 01110100 01100001 01101000 01110101 01101110</div>
                    <div class="passed-stamp">ELIGIBLE FOR LVL-17</div>
                </div>
            </section>

            <!-- Halaman 2: Calendar -->
            <section class="page-module victorian-bg" id="mod-2">
                <h2 class="text-center font-bold text-[10px] uppercase mb-10 border-b pb-2 tracking-[0.2em]">Logbook Operasional: Maret 2026</h2>
                <div class="grid grid-cols-7 gap-1 text-[11px] text-center p-4 bg-white/50 border border-black/10">
                    <script>
                        const days = ['S','S','R','K','J','S','M'];
                        days.forEach(d => document.write(`<div class="font-bold opacity-30 mb-2">${d}</div>`));
                        for(let i=1; i<=31; i++) document.write(`<div class="${i===30?'date-highlight':''} p-2">${i}</div>`);
                    </script>
                </div>
                <div class="radar-box">
                    <div class="monitor-line">
                        <div class="wave-pulse"></div>
                    </div>
                    <div class="data-readout uppercase">
                        <div>Target: Aristia F.</div>
                        <div>Coord: 30.0326.N</div>
                        <div>Status: Critical Path</div>
                        <div>Signal: Strong 100%</div>
                    </div>
                    <p class="text-[7px] opacity-40 mt-2 text-justify">Pemantauan transmisi otomatis diaktifkan untuk periode peralihan umur. Seluruh sistem sinkron dengan detak waktu target.</p>
                </div>
                <div class="mt-auto pt-6 text-red-900 text-center text-xl italic" style="font-family: 'Special Elite';">Momen krusial di tanggal 30.</div>
            </section>

            <!-- Halaman 3: Surprise Candle & Typewriter (PERBAIKAN DILAKUKAN DISINI) -->
            <section class="page-module" id="mod-3">
                <div id="candle-stage">
                    <div class="candle">
                        <div class="candle-glow"></div>
                        <div class="flame" onclick="DossierSystem.extinguish()"></div>
                    </div>
                    <p class="candle-hint">Tap flame to initiate</p>
                </div>
                <div class="flex justify-between items-end mb-8 opacity-40">
                    <h2 class="text-[9px] font-bold uppercase tracking-widest">Internal Memo: Confidential</h2>
                    <span class="text-[8px]">LOG-ID: 300326</span>
                </div>
                <!-- Perbaikan dilakukan via CSS di atas: text-align left & min-height -->
                <div id="typewriter-output"></div>
                <div id="wax-seal-area" class="wax-seal-decoration">
                    <div class="red-ribbon"></div>
                    <div class="wax-seal"></div>
                    <div class="verification-grid">
                        <div class="bio-info">
                            <div class="bio-row">AUTH: <span class="bio-val">OPR_N</span></div>
                            <div class="bio-row">SESS: <span class="bio-val">AF-17</span></div>
                            <div class="bio-row">SIG: <span class="bio-val">ENCR</span></div>
                        </div>
                        <div class="retro-qr-graphic"></div>
                    </div>
                    <div class="footer-shred"></div>
                    <p class="text-[7px] opacity-30 uppercase tracking-[0.4em] -mt-2">Official Archive Termination</p>
                </div>
            </section>

            <!-- Halaman 4: Chat Terminal -->
            <section class="page-module" id="mod-4">
                <!-- Header: z-50 untuk mengalahkan nav-zone -->
                <div class="flex justify-between items-center mb-4 border-b pb-2 border-black/10 relative z-50">
                    <h2 class="text-[10px] font-bold uppercase opacity-40 tracking-widest">Terminal Comms</h2>
                    <button onclick="DossierSystem.openModal()" class="text-[9px] text-red-700 font-bold uppercase underline">Purge</button>
                </div>
                
                <!-- Msg Display: z-50 untuk scrollbar dan copy text -->
                <div id="msg-display" class="relative z-50"></div>
                
                <!-- Input Footer: z-50 AGAR BISA DIKLIK (solusi untuk "tombol gabisa ditekan") -->
                <div class="mt-4 pt-4 border-t border-black/10 relative z-50">
                    <div class="identity-toggle">
                        <div id="btn-n" onclick="DossierSystem.setSender('N')" class="toggle-btn active">Operator N</div>
                        <div id="btn-aristia" onclick="DossierSystem.setSender('Aristia')" class="toggle-btn">Aristia</div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="msg-field" placeholder="Input transmission..." class="flex-1 bg-transparent border-b border-black/20 outline-none text-[12px] py-2" autocomplete="off">
                        <button onclick="DossierSystem.send()" class="bg-black text-white text-[9px] px-5 py-2 uppercase font-bold">Send</button>
                    </div>
                </div>
            </section>
        </div>

        <footer class="p-4 border-t border-black/5 flex justify-between items-center text-[8px] opacity-40 font-bold tracking-widest uppercase">
            <div class="flex items-center">
                <span id="back-nav-btn" onclick="DossierSystem.prev()">[ BACK ]</span>
                <span>Dossier Cryptography v1.15</span>
            </div>
            <span id="center-stamp">AUTHORIZED ACCESS ONLY</span>
            <span id="page-num">1 / 5</span>
        </footer>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://muhatawchjjisjalopab.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11aGF0YXdjaGpqaXNqYWxvcGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDU0MjAsImV4cCI6MjA4NTQyMTQyMH0.RGRSrdKWfF8aWy4kVSvAwEHKaohVCXLNs4PbcP0TqoI';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const TABLE_NAME = 'messages';

        const DossierSystem = {
            index: 0,
            currentSender: 'N',
            isTyping: false,
            candleBlown: false,

            init() {
                document.getElementById('pin-field').oninput = (e) => {
                    if(e.target.value === "300326") this.runConstellationTransition();
                };
                
                // Mencegah duplicate subscription jika init dipanggil ulang
                if (!this.subscription) {
                    this.subscription = supabase.channel('messages_channel')
                        .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_NAME }, () => this.loadMsgs())
                        .subscribe();
                }
                
                this.render();
                document.getElementById('msg-field').addEventListener('keypress', (e) => { if(e.key==='Enter') this.send(); });
            },

            showPin() {
                document.getElementById('init-screen').style.display = 'none';
                document.getElementById('pin-screen').style.display = 'block';
                document.getElementById('pin-field').focus();
            },

            runConstellationTransition() {
                const loader = document.getElementById('constellation-loader');
                loader.style.display = 'flex';
                setTimeout(() => loader.style.opacity = '1', 10);
                setTimeout(() => {
                    loader.style.opacity = '0';
                    this.unlock();
                    setTimeout(() => loader.style.display = 'none', 500);
                }, 2500);
            },

            unlock() {
                const authModule = document.getElementById('auth-module');
                authModule.style.opacity = '0';
                setTimeout(() => { authModule.style.display = 'none'; }, 800);
            },

            setSender(name) {
                this.currentSender = name;
                document.getElementById('btn-n').classList.toggle('active', name === 'N');
                document.getElementById('btn-aristia').classList.toggle('active', name === 'Aristia');
            },

            render() {
                document.querySelectorAll('.page-module').forEach((m, i) => m.classList.toggle('active', i === this.index));
                document.getElementById('page-num').innerText = `${this.index + 1} / 5`;
                
                const backBtn = document.getElementById('back-nav-btn');
                const centerStamp = document.getElementById('center-stamp');

                // Logic Back Button
                if (this.index === 4) {
                    backBtn.style.display = 'inline-block';
                    centerStamp.style.display = 'none';
                    this.loadMsgs();
                } else {
                    backBtn.style.display = 'none';
                    centerStamp.style.display = 'inline-block';
                }

                if(this.index === 3 && !this.candleBlown) {
                    document.getElementById('candle-stage').style.display = 'flex';
                    document.getElementById('candle-stage').style.opacity = '1';
                }
            },

            extinguish() {
                const flash = document.getElementById('flash-overlay');
                flash.classList.add('flash-active');
                
                setTimeout(() => {
                    document.getElementById('candle-stage').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('candle-stage').style.display = 'none';
                        this.candleBlown = true;
                        this.type();
                    }, 1000);
                    flash.classList.remove('flash-active');
                }, 400); 
            },

            next() { if(this.index < 4) { this.index++; this.render(); } },
            prev() { if(this.index > 0) { this.index--; this.render(); } },

            type() {
                if(this.isTyping) return;
                this.isTyping = true;
                const out = document.getElementById('typewriter-output');
                const seal = document.getElementById('wax-seal-area');
                const page3 = document.getElementById('mod-3');
                const txt = "Di hari yang luar biasa spesial ini, aku ingin kamu tahu betapa berartinya setiap detik kehadiranmu bagi duniaku. Selamat ulang tahun yang ke-17, sayangku.\n\nTujuh belas adalah awal dari petualangan yang lebih dewasa, lebih menantang. Aku akan tetap di sini, di sisimu, memastikan setiap memori kita tersimpan dengan aman dalam arsip rahasia ini.\n\nStay wonderful, sayangku. Happy 17th!";
                out.innerText = ""; 
                let i = 0;
                seal.style.opacity = "0";

                const intrvl = setInterval(() => {
                    out.innerText += txt[i]; 
                    i++;
                    if(i >= txt.length) { 
                        clearInterval(intrvl); 
                        this.isTyping = false;
                        setTimeout(() => { 
                            page3.classList.add('victorian-bg'); 
                            seal.style.opacity = "1"; 
                        }, 500);
                    }
                }, 45); 
            },

            /* --- UPDATED CHAT LOGIC (ROBUST + SORTING) --- */
            async loadMsgs() {
                try {
                    const orderCol = 'created_at';
                    let q = supabase.from(TABLE_NAME).select('*');
                    q = q.order(orderCol, { ascending: true });
                    const { data, error } = await q;

                    if (error) {
                        console.warn('loadMsgs retry (id sort):', error.message);
                        const r = await supabase.from(TABLE_NAME).select('*').order('id', { ascending: true });
                        if (r.error) throw r.error;
                        this.renderMsgs(r.data);
                        return;
                    }
                    this.renderMsgs(data);
                } catch (err) {
                    console.error('loadMsgs failed:', err);
                    const box = document.getElementById('msg-display');
                    if (box) box.innerHTML = '<p class="text-center opacity-20 py-10 italic text-[9px]">Channel error â€” check console.</p>';
                }
            },

            renderMsgs(data) {
                const box = document.getElementById('msg-display');
                if(!box) return;
                box.innerHTML = (data && data.length > 0) ? data.map(m => `
                    <div class="message-bubble ${m.sender === 'N' ? 'msg-n' : 'msg-aristia'}">
                        <span class="block text-[6px] font-bold opacity-40 mb-1 uppercase">${m.sender}</span>
                        <div>${m.content}</div>
                    </div>
                `).join('') : '<p class="text-center opacity-20 py-10 italic text-[9px]">Channel empty.</p>';
                box.scrollTop = box.scrollHeight;
            },

            async send() {
                const f = document.getElementById('msg-field');
                if(!f || !f.value.trim()) return;
                const content = f.value.trim();
                f.value = '';
                try {
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .insert([{ content: content, sender: this.currentSender }])
                        .select();
                        
                    if (error) {
                        console.error('Supabase insert error:', error);
                        alert('Gagal mengirim pesan (cek console).');
                        return;
                    }

                    if (data && data.length) {
                        // Optimistic / Reload
                        const { data: newData } = await supabase.from(TABLE_NAME).select('*').order('created_at', { ascending: true });
                        this.renderMsgs(newData);
                    } else {
                        this.loadMsgs();
                    }
                } catch (err) {
                    console.error('send() unexpected error:', err);
                }
            },

            openModal() { document.getElementById('delete-modal').style.display = 'flex'; },
            closeModal() { document.getElementById('delete-modal').style.display = 'none'; },

            async confirmPurge() {
                try {
                    await supabase.from(TABLE_NAME).delete().neq('id', -1);
                    this.loadMsgs(); 
                    this.closeModal();
                } catch(e) {
                    console.error("Purge error", e);
                }
            }
        };

        window.DossierSystem = DossierSystem;
        DossierSystem.init();
    </script>
</body>
</html>

